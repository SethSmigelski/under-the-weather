function validateCoordinates(e,t){const a=parseFloat(e),n=parseFloat(t);return a>=-90&&a<=90&&n>=-180&&n<=180}function validateWeatherData(e){return e&&e.current&&e.daily&&Array.isArray(e.daily)&&e.daily.length>0}function parseCoordinate(e){if(!e||"string"!=typeof e)return null;let t=e.trim();t.endsWith(",")&&(t=t.slice(0,-1).trim());let a=t.match(/([0-9]{1,3})[°\s]+([0-9]+(?:\.[0-9]+)?)['\s]+([NSEW])/i);if(a){const e=parseFloat(a[1]),t=parseFloat(a[2]),n=a[3].toUpperCase();if(isNaN(e)||isNaN(t))return null;let r=e+t/60;return"S"!==n&&"W"!==n||(r=-r),parseFloat(r.toFixed(4))}if(a=t.match(/([0-9]{1,3})[°\s]+([0-9]{1,2})['\s]+([0-9]{1,2}(?:\.[0-9]+)?)["\s]+([NSEW])/i),a){const e=parseFloat(a[1]),t=parseFloat(a[2]),n=parseFloat(a[3]),r=a[4].toUpperCase();if(isNaN(e)||isNaN(t)||isNaN(n))return null;let s=e+t/60+n/3600;return"S"!==r&&"W"!==r||(s=-s),parseFloat(s.toFixed(4))}const n=parseFloat(t);return isNaN(n)?null:n}function displayWeather(e,t){const{style_set:a,display_mode:n,forecast_days:r,show_details:s,show_timestamp:o,show_unit:i}=under_the_weather_settings,d=t.dataset.locationName||"",l="°",c="metric"===e.units?"C":"F",u="metric"===e.units?"kph":"mph",h=i?`<span class="temp-unit">${c}</span>`:"";function p(e){return"weather_icons_font"===a?`<i class="wi ${e.icon_class}"></i>`:`<img src="${under_the_weather_plugin_url.url}images/default-weather-images-${e.icon}.png" alt="${e.description}">`}let w="";if("today_forecast"===n){const t=e.daily[0],a=Math.round(t.temp.max),n=Math.round(t.temp.min);w=`<div class="current-weather"><div class="today-forecast-temps"><div class="today-forecast-label">Today</div><div class="temps-wrapper"><span class="high">${a}${l}</span> / <span class="low">${n}${l}</span>${h}</div></div><div class="current-conditions">${p(t.weather[0])}<span>${t.weather[0].description}</span></div></div>`}else{const t=e.current;w=`<div class="current-weather"><div class="current-temp">${Math.round(t.temp)}${l}${h}</div><div class="current-conditions">${p(t.weather[0])}<span>${t.weather[0].description}</span></div></div>`}let f="";if(s){const t=Math.round(e.current.feels_like),a=Math.round(e.current.wind_speed),n=(v=e.current.wind_deg,["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"][Math.round(v/22.5)%16]),r=function(e){return`wi wi-wind from-${Math.round(e)}-deg`}(e.current.wind_deg);f=`<div class="weather-extra-details"><span>Feels like: ${t}${l}${h}</span><span class="wind-details"><i class="${r}"></i> ${n} ${a} ${u}</span></div>`}var v;const m=parseInt(r,10)||5,$=e.daily.slice(1,1+m);let g="";$.forEach((e=>{const t=new Date(1e3*e.dt).toLocaleDateString("en-US",{weekday:"short"}),a=Math.round(e.temp.max),n=Math.round(e.temp.min);g+=`<div class="forecast-day"><div class="forecast-day-name">${t}</div>${p(e.weather[0])}<div class="forecast-temps"><span class="high">${a}${l}</span> / <span class="low">${n}${l}</span></div></div>`}));let N="";o&&e.fetched_at&&(N=`<div class="last-updated">Updated ${function(e){const t=(new Date).getTime()/1e3,a=Math.floor(t-e);if(a<60)return"just now";let n=a/31536e3;return n>1?Math.floor(n)+" years ago":(n=a/2592e3,n>1?Math.floor(n)+" months ago":(n=a/86400,n>1?Math.floor(n)+" days ago":(n=a/3600,n>1?Math.floor(n)+" hours ago":(n=a/60,n>1?Math.floor(n)+" minutes ago":"a minute ago"))))}(e.fetched_at)}</div>`);const _=`<div class="weather-location-name">${d}</div>${w}${f}<div class="forecast-container">${g}</div>${N}`;t.innerHTML=_}document.addEventListener("DOMContentLoaded",(function(){const e=document.querySelector(".weather-widget");if(!e)return;const t=e.dataset.locationName,a=e.dataset.unit?e.dataset.unit.toLowerCase():"imperial",n=new AbortController,r=setTimeout((()=>n.abort()),1e4);let s=e.dataset.lat,o=e.dataset.lon;const i=parseCoordinate(s),d=parseCoordinate(o);if(null!==i&&(s=i),null!==d&&(o=d),!s||!o||!t)return void(e.innerHTML="Location data is missing.");if(!validateCoordinates(s,o))return void(e.innerHTML="Invalid location coordinates.");e.innerHTML='<div class="weather-loading">Loading weather data...</div>';const l=`/wp-json/under-the-weather/v1/forecast?lat=${s}&lon=${o}&location_name=${encodeURIComponent(t)}&unit=${a}`;fetch(l,{signal:n.signal,headers:{"X-WP-Nonce":under_the_weather_settings.nonce}}).then((t=>{if(clearTimeout(r),!t.ok)throw t.text().then((t=>{console.error("Error fetching weather data:",t),e.innerHTML="<p>Could not retrieve forecast. Server error.</p>"})),new Error("Network response was not ok");return t.json()})).then((t=>{if(!validateWeatherData(t))throw new Error("The weather data structure is invalid");displayWeather(t,e)})).catch((t=>{console.error("Network Error:",t),e.innerHTML="<p>Unable to load weather data. Please try again later.</p>"}))}));
