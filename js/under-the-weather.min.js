function loadWeatherData(e){const t=e.dataset.locationName;let n=e.dataset.lat,s=e.dataset.lon;const a=parseCoordinate(n),i=parseCoordinate(s);if(null!==a&&(n=a),null!==i&&(s=i),!n||!s||!t)return void(e.innerHTML="Location data is missing.");if(!validateCoordinates(n,s))return void(e.innerHTML="Invalid location coordinates.");e.innerHTML='<div class="weather-loading">Loading weather data...</div>';const r=e.dataset.unit?e.dataset.unit.toLowerCase():"imperial",l=new AbortController,o=setTimeout((()=>l.abort()),1e4),d=`/wp-json/under-the-weather/v1/forecast?lat=${n}&lon=${s}&location_name=${encodeURIComponent(t)}&unit=${r}`;fetch(d,{signal:l.signal,headers:{"X-WP-Nonce":under_the_weather_settings.nonce}}).then((t=>{if(clearTimeout(o),!t.ok)throw t.text().then((t=>{console.error("Error fetching weather data:",t),e.innerHTML="<p>Could not retrieve forecast. Server error.</p>"})),new Error("Network response was not ok");return t.json()})).then((t=>{if(!validateWeatherData(t))throw new Error("The weather data structure is invalid");displayWeather(t,e)})).catch((t=>{console.error("Network Error:",t),e.innerHTML="<p>Unable to load weather data. Please try again later.</p>"}))}function validateCoordinates(e,t){const n=parseFloat(e),s=parseFloat(t);return n>=-90&&n<=90&&s>=-180&&s<=180}function validateWeatherData(e){return e&&e.current&&e.daily&&Array.isArray(e.daily)&&e.daily.length>0}function parseCoordinate(e){if(!e||"string"!=typeof e)return null;let t=e.trim();t.endsWith(",")&&(t=t.slice(0,-1).trim());let n=t.match(/([0-9]{1,3})[°\s]+([0-9]+(?:\.[0-9]+)?)['\s]+([NSEW])/i);if(n){const e=parseFloat(n[1]),t=parseFloat(n[2]),s=n[3].toUpperCase();if(isNaN(e)||isNaN(t))return null;let a=e+t/60;return"S"!==s&&"W"!==s||(a=-a),parseFloat(a.toFixed(4))}if(n=t.match(/([0-9]{1,3})[°\s]+([0-9]{1,2})['\s]+([0-9]{1,2}(?:\.[0-9]+)?)["\s]+([NSEW])/i),n){const e=parseFloat(n[1]),t=parseFloat(n[2]),s=parseFloat(n[3]),a=n[4].toUpperCase();if(isNaN(e)||isNaN(t)||isNaN(s))return null;let i=e+t/60+s/3600;return"S"!==a&&"W"!==a||(i=-i),parseFloat(i.toFixed(4))}const s=parseFloat(t);return isNaN(s)?null:s}function getAlertIconClass(e){const t=e.toLowerCase();return t.includes("tornado")?"wi-tornado":t.includes("hurricane")?"wi-hurricane-warning":t.includes("tsunami")?"wi-tsunami":t.includes("earthquake")?"wi-earthquake":t.includes("thunderstorm")||t.includes("lightning")?"wi-thunderstorm":t.includes("gale")?"wi-gale-warning":t.includes("hail")?"wi-hail":t.includes("rain")||t.includes("showers")||t.includes("drizzle")?"wi-rain":t.includes("flood")?"wi-flood":t.includes("winter")||t.includes("snow")||t.includes("blizzard")?"wi-snow":t.includes("ice")||t.includes("frost")||t.includes("freeze")||t.includes("cold")||t.includes("chill")?"wi-snowflake-cold":t.includes("heat")||t.includes("hot")?"wi-hot":t.includes("wind")?"wi-strong-wind":t.includes("fog")?"wi-fog":t.includes("fire")?"wi-fire":t.includes("smoke")?"wi-smoke":t.includes("smog")||t.includes("air quality")?"wi-smog":t.includes("dust")?"wi-dust":t.includes("sandstorm")||t.includes("sand")?"wi-sandstorm":"wi-storm-warning"}function displayWeather(e,t){const{style_set:n,display_mode:s,forecast_days:a,show_details:i,show_unit:r,show_alerts:l,show_timestamp:o,sunrise_sunset_format:d}=under_the_weather_settings,c=t.dataset.locationName||"",u="°",h="metric"===e.units?"C":"F",w="metric"===e.units?"kph":"mph",p=r?`<span class="temp-unit">${h}</span>`:"";function m(e){return"weather_icons_font"===n?`<i class="wi ${e.icon_class}"></i>`:`<img src="${under_the_weather_plugin_url.url}images/default-weather-images-${e.icon}.png" alt="${e.description}">`}let v="";if("off"!==d&&e.current.sunrise&&e.current.sunset){const t={timeZone:e.timezone,hour:"numeric",minute:"2-digit",hour12:"12"===d},s=new Date(1e3*e.current.sunrise).toLocaleTimeString("en-US",t),a=new Date(1e3*e.current.sunset).toLocaleTimeString("en-US",t);let i="",r="";if("weather_icons_font"===n)i='<i class="wi wi-sunrise"></i>',r='<i class="wi wi-sunset"></i>';else{i=`<img src="${`${under_the_weather_plugin_url.url}images/seths--weather-images-sunrise.png`}" class="sunrise-sunset-icon" alt="Sunrise Time">`,r=`<img src="${`${under_the_weather_plugin_url.url}images/seths--weather-images-sunset.png`}" class="sunrise-sunset-icon" alt="Sunset Time">`}v=`<div class="sunrise-sunset-container"><div class="sunrise-time">${i}<div class="sunrise-sunset-label">Sunrise</div><div class="sunrise-sunset-value">${s}</div></div><div class="sunset-time">${r}<div class="sunrise-sunset-label">Sunset</div><div class="sunrise-sunset-value">${a}</div></div></div>`}let f="";if("today_forecast"===s){const t=e.daily[0],n=Math.round(t.temp.max),s=Math.round(t.temp.min);f=`<div class="current-weather"><div class="today-forecast-temps"><div class="today-forecast-label">Today</div><div class="temps-wrapper">  <span class="high">${n}${u}</span><span class="slash"> / </span><span class="low">${s}${u}</span>${p}</div></div><div class="current-conditions">${m(t.weather[0])}<span>${t.weather[0].description}</span></div></div>`}else{const t=e.current;f=`<div class="current-weather"><div class="current-temp">${Math.round(t.temp)}${u}${p}</div><div class="current-conditions">${m(t.weather[0])}<span>${t.weather[0].description}</span></div></div>`}let g="";if(i){const t=Math.round(e.current.feels_like),n=Math.round(e.current.wind_speed),s=($=e.current.wind_deg,["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"][Math.round($/22.5)%16]),a=function(e){return`wi wi-wind from-${Math.round(e)}-deg`}(e.current.wind_deg);g=`<div class="weather-extra-details"><span>Feels like: ${t}${u}${p}</span><span class="wind-details"><i class="${a}"></i> ${s} ${n} ${w}</span></div>`}var $;let _="";l&&e.alerts&&e.alerts.length>0&&e.alerts.forEach((e=>{let t="";if("weather_icons_font"===n){t=`<i class="wi ${getAlertIconClass(e.event)}"></i>`}else{t=`<img src="${`${under_the_weather_plugin_url.url}images/seths--weather-images-warning.png`}" class="weather-alert-icon" alt="Weather Alert">`}_+=`\n\t\t\t\t<div class="weather-alert">\n\t\t\t\t\t<div class="weather-alert-icon-left">\n\t\t\t\t\t\t${t}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="weather-alert-message">\n\t\t\t\t\t\t<div class="weather-alert-event">${e.event}</div>\n\t\t\t\t\t\t<div class="weather-alert-sender">Issued by: ${e.sender_name}</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>`}));const N=parseInt(a,10)||5,y=e.daily.slice(1,1+N);let S="";y.forEach((e=>{const t=new Date(1e3*e.dt).toLocaleDateString("en-US",{weekday:"short"}),n=Math.round(e.temp.max),s=Math.round(e.temp.min);S+=`  <div class="forecast-day"><div class="forecast-day-name">${t}</div>${m(e.weather[0])}<div class="forecast-temps">  <span class="high">${n}${u}</span><span class="slash"> / </span><span class="low">${s}${u}</span></div>  </div>`}));let M="";o&&e.fetched_at&&(M=`<div class="last-updated">Updated ${function(e){const t=(new Date).getTime()/1e3,n=Math.floor(t-e);if(n<60)return"just now";let s=n/31536e3;return s>1?Math.floor(s)+" years ago":(s=n/2592e3,s>1?Math.floor(s)+" months ago":(s=n/86400,s>1?Math.floor(s)+" days ago":(s=n/3600,s>1?Math.floor(s)+" hours ago":(s=n/60,s>1?Math.floor(s)+" minutes ago":"a minute ago"))))}(e.fetched_at)}</div>`);const W=`<div class="weather-location-name">${c}</div>${_}\n\t\t${f}${g}\n\t\t${v}<div class="forecast-container">${S}</div>${M}\n`;t.innerHTML=W}document.addEventListener("DOMContentLoaded",(function(){const e=document.querySelectorAll(".weather-widget");0!==e.length&&e.forEach((e=>{loadWeatherData(e)}))}));
