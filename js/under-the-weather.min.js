function loadWeatherData(e){const n=e.dataset.locationName;let s=e.dataset.lat,t=e.dataset.lon;const i=parseCoordinate(s),a=parseCoordinate(t);if(null!==i&&(s=i),null!==a&&(t=a),!s||!t||!n)return void(e.innerHTML="Location data is missing.");if(!validateCoordinates(s,t))return void(e.innerHTML="Invalid location coordinates.");e.innerHTML='<div class="weather-loading">Loading weather data...</div>';const r=e.dataset.unit?e.dataset.unit.toLowerCase():"imperial",l=new AbortController,o=setTimeout((()=>l.abort()),1e4),d=`/wp-json/under-the-weather/v1/forecast?lat=${s}&lon=${t}&location_name=${encodeURIComponent(n)}&unit=${r}`;fetch(d,{signal:l.signal,headers:{"X-WP-Nonce":under_the_weather_settings.nonce}}).then((n=>{if(clearTimeout(o),!n.ok)throw n.text().then((n=>{console.error("Error fetching weather data:",n),e.innerHTML="<p>Could not retrieve forecast. Server error.</p>"})),new Error("Network response was not ok");return n.json()})).then((n=>{if(!validateWeatherData(n))throw new Error("The weather data structure is invalid");displayWeather(n,e)})).catch((n=>{console.error("Network Error:",n),e.innerHTML="<p>Unable to load weather data. Please try again later.</p>"}))}function validateCoordinates(e,n){const s=parseFloat(e),t=parseFloat(n);return s>=-90&&s<=90&&t>=-180&&t<=180}function validateWeatherData(e){return e&&e.current&&e.daily&&Array.isArray(e.daily)&&e.daily.length>0}function parseCoordinate(e){if(!e||"string"!=typeof e)return null;let n=e.trim();n.endsWith(",")&&(n=n.slice(0,-1).trim());let s=n.match(/([0-9]{1,3})[°\s]+([0-9]+(?:\.[0-9]+)?)['\s]+([NSEW])/i);if(s){const e=parseFloat(s[1]),n=parseFloat(s[2]),t=s[3].toUpperCase();if(isNaN(e)||isNaN(n))return null;let i=e+n/60;return"S"!==t&&"W"!==t||(i=-i),parseFloat(i.toFixed(4))}if(s=n.match(/([0-9]{1,3})[°\s]+([0-9]{1,2})['\s]+([0-9]{1,2}(?:\.[0-9]+)?)["\s]+([NSEW])/i),s){const e=parseFloat(s[1]),n=parseFloat(s[2]),t=parseFloat(s[3]),i=s[4].toUpperCase();if(isNaN(e)||isNaN(n)||isNaN(t))return null;let a=e+n/60+t/3600;return"S"!==i&&"W"!==i||(a=-a),parseFloat(a.toFixed(4))}const t=parseFloat(n);return isNaN(t)?null:t}function getAlertIconClass(e){const n=e.toLowerCase();return n.includes("tornado")?"wi-tornado":n.includes("hurricane")?"wi-hurricane-warning":n.includes("tsunami")?"wi-tsunami":n.includes("earthquake")?"wi-earthquake":n.includes("thunderstorm")||n.includes("lightning")?"wi-thunderstorm":n.includes("gale")?"wi-gale-warning":n.includes("hail")?"wi-hail":n.includes("rain")||n.includes("showers")||n.includes("drizzle")?"wi-rain":n.includes("flood")?"wi-flood":n.includes("winter")||n.includes("snow")||n.includes("blizzard")?"wi-snow":n.includes("ice")||n.includes("frost")||n.includes("freeze")||n.includes("cold")||n.includes("chill")?"wi-snowflake-cold":n.includes("heat")||n.includes("hot")?"wi-hot":n.includes("wind")?"wi-strong-wind":n.includes("fog")?"wi-fog":n.includes("fire")?"wi-fire":n.includes("smoke")?"wi-smoke":n.includes("smog")||n.includes("air quality")?"wi-smog":n.includes("dust")?"wi-dust":n.includes("sandstorm")||n.includes("sand")?"wi-sandstorm":"wi-storm-warning"}function getAlertSVGFilename(e){const n=e.toLowerCase();return n.includes("tornado")?"tornado":n.includes("hurricane")?"hurricane":n.includes("tsunami")||n.includes("earthquake")?"code-red":n.includes("thunderstorm")||n.includes("lightning")?"thunderstorms-extreme":n.includes("gale")?"flag-gale-warning":n.includes("hail")?"hail":n.includes("rain")||n.includes("showers")||n.includes("drizzle")?"extreme-rain":n.includes("flood")?"tide-high":n.includes("winter")||n.includes("snow")||n.includes("blizzard")?"extreme-snow":n.includes("ice")||n.includes("frost")||n.includes("freeze")||n.includes("cold")||n.includes("chill")?"snowflake":n.includes("heat")||n.includes("hot")?"sun-hot":n.includes("wind")?"wind-alert":n.includes("fog")?"extreme-fog":n.includes("fire")?"code-red":n.includes("smoke")?"extreme-smoke":n.includes("smog")||n.includes("air quality")?"smoke-particles":n.includes("dust")?"dust":n.includes("sandstorm")||n.includes("sand")?"dust-wind":"code-orange"}function displayWeather(e,n){const{style_set:s,display_mode:t,forecast_days:i,show_details:a,show_unit:r,show_alerts:l,show_timestamp:o,sunrise_sunset_format:d}=under_the_weather_settings,c=n.dataset.locationName||"",u="°",h="metric"===e.units?"C":"F",w="metric"===e.units?"kph":"mph",g=r?`<span class="temp-unit">${h}</span>`:"";function v(e){if("svg_fill"===s||"svg_outline"===s){const n="svg_fill"===s?"fill":"outline";return`<img class="weather-icon-svg" src="${`${under_the_weather_plugin_url.url}svg/${n}/${e.svg_icon_name}.svg`}" alt="${e.description}">`}return"weather_icons_font"===s?`<i class="wi ${e.icon_class}"></i>`:`<img src="${under_the_weather_plugin_url.url}images/default-weather-images-${e.icon}.png" alt="${e.description}">`}let m="";if("off"!==d&&e.current.sunrise&&e.current.sunset){const n={timeZone:e.timezone,hour:"numeric",minute:"2-digit",hour12:"12"===d},t=new Date(1e3*e.current.sunrise).toLocaleTimeString("en-US",n),i=new Date(1e3*e.current.sunset).toLocaleTimeString("en-US",n);let a="",r="";if("svg_fill"===s||"svg_outline"===s){const e="svg_fill"===s?"fill":"outline";a=`<img src="${`${under_the_weather_plugin_url.url}svg/${e}/sunrise.svg`}" class="sunrise-sunset-icon-svg" alt="Sunrise Time">`,r=`<img src="${`${under_the_weather_plugin_url.url}svg/${e}/sunset.svg`}" class="sunrise-sunset-icon-svg" alt="Sunset Time">`}else if("weather_icons_font"===s)a='<i class="wi wi-sunrise"></i>',r='<i class="wi wi-sunset"></i>';else{a=`<img src="${`${under_the_weather_plugin_url.url}images/seths--weather-images-sunrise.png`}" class="sunrise-sunset-icon" alt="Sunrise Time">`,r=`<img src="${`${under_the_weather_plugin_url.url}images/seths--weather-images-sunset.png`}" class="sunrise-sunset-icon" alt="Sunset Time">`}m=`<div class="sunrise-sunset-container"><div class="sunrise-time">${a}<div class="sunrise-sunset-text-wrapper"><div class="sunrise-sunset-label">Sunrise</div><div class="sunrise-sunset-value">${t}</div></div></div><div class="sunset-time">${r} <div class="sunrise-sunset-text-wrapper"><div class="sunrise-sunset-label">Sunset</div><div class="sunrise-sunset-value">${i}</div></div></div></div>`}let f="";if("today_forecast"===t){const n=e.daily[0],s=Math.round(n.temp.max),t=Math.round(n.temp.min);f=`<div class="current-weather"><div class="today-forecast-temps"><div class="today-forecast-label">Today</div><div class="temps-wrapper">  <span class="high">${s}${u}</span><span class="slash"> / </span><span class="low">${t}${u}</span>${g}</div></div><div class="current-conditions">${v(n.weather[0])}<span>${n.weather[0].description}</span></div></div>`}else{const n=e.current;f=`<div class="current-weather"><div class="current-temp">${Math.round(n.temp)}${u}${g}</div><div class="current-conditions">${v(n.weather[0])}<span>${n.weather[0].description}</span></div></div>`}let p="";if(a){const n=Math.round(e.current.feels_like),t=Math.round(e.current.wind_speed),i=(_=e.current.wind_deg,["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"][Math.round(_/22.5)%16]);let a="";if("svg_fill"===s||"svg_outline"===s){const e="svg_fill"===s?"fill":"outline";a=`<img class="wind-icon-svg" src="${`${under_the_weather_plugin_url.url}svg/${e}/wind.svg`}" alt="Wind Icon">`}else a=`<i class="${function(e){return`wi wi-wind from-${Math.round(e)}-deg`}(e.current.wind_deg)}"></i>`;p=`<div class="weather-extra-details"><span>Feels like: ${n}${u}${g}</span><span class="wind-details">${a} ${i} ${t} ${w}</span></div>`}var _;let $="";l&&e.alerts&&e.alerts.length>0&&e.alerts.forEach((e=>{let n="";if("svg_fill"===s||"svg_outline"===s){const t="svg_fill"===s?"fill":"outline",i=getAlertSVGFilename(e.event);n=`<img src="${`${under_the_weather_plugin_url.url}svg/${t}/${i}.svg`}" class="weather-alert-icon-svg" alt="Weather Alert">`}else if("weather_icons_font"===s)n=`<i class="wi ${getAlertIconClass(e.event)}"></i>`;else{n=`<img src="${`${under_the_weather_plugin_url.url}images/seths--weather-images-warning.png`}" class="weather-alert-icon" alt="Weather Alert">`}$+=`<div class="weather-alert"><div class="weather-alert-icon-left">${n}</div><div class="weather-alert-message"><div class="weather-alert-event">${e.event}</div><div class="weather-alert-sender">Issued by: ${e.sender_name}</div></div></div>`}));const S=parseInt(i,10)||5,N=e.daily.slice(1,1+S);let y="";N.forEach((e=>{const n=new Date(1e3*e.dt).toLocaleDateString("en-US",{weekday:"short"}),s=Math.round(e.temp.max),t=Math.round(e.temp.min);y+=`  <div class="forecast-day"><div class="forecast-day-name">${n}</div>${v(e.weather[0])}<div class="forecast-temps">  <span class="high">${s}${u}</span><span class="slash"> / </span><span class="low">${t}${u}</span></div>  </div>`}));let W="";o&&e.fetched_at&&(W=`<div class="last-updated">Updated ${function(e){const n=(new Date).getTime()/1e3,s=Math.floor(n-e);if(s<60)return"just now";let t=s/60;return t<60?Math.floor(t)+" minutes ago":(t/=60,t<24?Math.floor(t)+" hours ago":(t/=24,t<30?Math.floor(t)+" days ago":(t/=30,t<12?Math.floor(t)+" months ago":(t/=12,Math.floor(t)+" years ago"))))}(e.fetched_at)}</div>`);const M=`<div class="weather-location-name">${c}</div>${$}${f}${p}${m}<div class="forecast-container">${y}</div>${W}`;n.innerHTML=M}document.addEventListener("DOMContentLoaded",(function(){const e=document.querySelectorAll(".weather-widget");0!==e.length&&e.forEach((e=>{loadWeatherData(e)}))}));
